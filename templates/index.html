<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Printable SVG Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #14532d 0%, #166534 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .main-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 600px;
        }
        
        .controls {
            background: #f7f9fc;
            padding: 30px;
            border-right: 1px solid #e2e8f0;
        }
        
        .preview-area {
            padding: 30px;
            display: flex;
            flex-direction: column;
            background: white;
            height: 100%;
            position: relative;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            margin-bottom: 25px;
        }
        
        .upload-area:hover {
            border-color: #16a34a;
            background: #f7f9fc;
        }
        
        .upload-area.dragover {
            border-color: #16a34a;
            background: #f0fdf4;
        }
        
        .upload-area.has-file {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: default;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #cbd5e0;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            min-width: 0;  /* Allow flex item to shrink below content size */
            overflow: hidden;
        }
        
        .file-icon {
            font-size: 24px;
            color: #16a34a;
            flex-shrink: 0;  /* Prevent icon from shrinking */
        }
        
        .file-name {
            color: #2d3748;
            font-weight: 500;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .clear-file-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.3s;
            width: 100%;
            text-align: center;
        }
        
        .clear-file-btn:hover {
            background: #dc2626;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .range-value {
            text-align: right;
            color: #16a34a;
            font-weight: bold;
            font-size: 14px;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .color-palette-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .palette-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .color-chip {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .color-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .color-chip.selected {
            border-color: #16a34a;
            border-width: 3px;
        }
        
        .color-chip.selected::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 2px;
            background: #16a34a;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .color-chip.add-color {
            border: 2px dashed #cbd5e0;
            font-size: 24px;
            color: #cbd5e0;
        }
        
        .color-chip.add-color:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .color-input-wrapper {
            position: relative;
        }
        
        .color-picker-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .suggested-info {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
        
        button:not(.clear-file-btn):not(.tab-btn) {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .convert-btn {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            margin-bottom: 10px;
        }
        
        .convert-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(22, 163, 74, 0.4);
        }
        
        .convert-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .download-btn {
            background: #059669;
            color: white;
        }
        
        .download-btn:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .preview-container {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            min-height: 300px;
        }
        
        .preview-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        
        .tab-btn.active {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
        }
        
        .svg-preview {
            width: 100%;
            max-width: 500px;
            height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .svg-preview svg {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        .placeholder {
            color: #a0aec0;
            font-size: 18px;
            text-align: center;
        }
        
        .progress-container {
            background: #f7f9fc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            position: relative;
            flex-shrink: 0;
        }
        
        .progress-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            background: #f7f9fc;
            padding-bottom: 5px;
        }
        
        .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .spinner.active {
            display: inline-block;
        }
        
        .progress-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #2d3748;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry.status {
            color: #667eea;
            font-weight: 600;
        }
        
        .log-entry.error {
            color: #e53e3e;
            font-weight: 600;
        }
        
        .log-entry.log {
            color: #4a5568;
            padding-left: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
            
            .controls {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Image to Printable SVG Converter</h1>
        
        <div class="main-panel">
            <div class="controls">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content" id="uploadContent">
                        <div class="upload-icon">📁</div>
                        <p>Click to upload or drag & drop</p>
                        <p style="font-size: 12px; color: #a0aec0; margin-top: 10px;">
                            PNG, JPG, GIF, BMP, or SVG
                        </p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,.svg" style="display: none;">
                </div>
                
                <div class="control-group">
                    <label for="colors">Number of Colors</label>
                    <input type="range" id="colors" min="2" max="32" value="8">
                    <div class="range-value" id="colorsValue">8</div>
                </div>
                
                <div class="control-group">
                    <label for="method">Quantization Method</label>
                    <select id="method">
                        <option value="kmeans">K-means (Best quality)</option>
                        <option value="posterize">Posterize (Artistic)</option>
                        <option value="adaptive">Adaptive (Fast)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="threshold">Simplification Threshold</label>
                    <input type="range" id="threshold" min="0" max="255" value="128">
                    <div class="range-value" id="thresholdValue">128</div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="simplify" checked>
                    <label for="simplify">Simplify paths</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="includeBackground">
                    <label for="includeBackground">Include background</label>
                </div>
                
                <div class="control-group" id="svgOptions" style="display: none;">
                    <label>Gradient Handling (SVG only)</label>
                    <select id="gradientMode">
                        <option value="sample" selected>Sample gradient colors</option>
                        <option value="default">Keep gradients as-is</option>
                        <option value="remove">Remove gradients</option>
                        <option value="rasterize">Rasterize then convert</option>
                    </select>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                        • Sample colors: Include gradient colors in quantization (default)<br>
                        • Keep as-is: Preserve gradients unchanged<br>
                        • Remove: Convert gradients to solid colors<br>
                        • Rasterize: Convert to pixels first (best for complex gradients)
                    </div>
                    
                    <div id="rasterizeOptions" style="display: none; margin-top: 10px;">
                        <label for="rasterDpi" style="font-size: 13px;">Rasterization DPI</label>
                        <input type="range" id="rasterDpi" min="72" max="300" value="150">
                        <div class="range-value" id="rasterDpiValue">150</div>
                    </div>
                </div>
                
                <div class="color-palette-section">
                    <div class="palette-title">Suggested Colors (Optional)</div>
                    <div class="color-palette" id="colorPalette">
                        <div class="color-chip add-color" id="addColorBtn">+</div>
                    </div>
                    <div class="suggested-info" id="suggestedInfo">
                        Click + to add colors you want in the palette
                    </div>
                    <input type="color" class="color-picker-input" id="colorPicker">
                </div>
                
                <button class="convert-btn" id="convertBtn" disabled>
                    Convert to SVG
                </button>
                
                <button class="download-btn" id="downloadBtn" disabled>
                    Download SVG
                </button>
            </div>
            
            <div class="preview-area">
                <div class="preview-tabs" id="previewTabs" style="display: none;">
                    <button class="tab-btn active" data-tab="original">Original</button>
                    <button class="tab-btn" data-tab="svg">SVG Output</button>
                </div>
                
                <div class="preview-container">
                    <div class="placeholder" id="placeholder">
                        Upload an image to get started
                    </div>
                    <img class="preview-image" id="originalPreview" style="display: none;">
                    <div class="svg-preview" id="svgPreview" style="display: none;"></div>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-title">
                        <span class="spinner" id="progressSpinner"></span>
                        <span id="progressTitle">Conversion Log</span>
                    </div>
                    <div class="progress-log" id="progressLog">
                        <div class="log-entry" style="color: #a0aec0; font-style: italic;">No conversion activity yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentFile = null;
        let currentSVG = null;
        let currentTab = 'original';
        let suggestedColors = [];
        
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const placeholder = document.getElementById('placeholder');
        const previewTabs = document.getElementById('previewTabs');
        const progressContainer = document.getElementById('progressContainer');
        const progressLog = document.getElementById('progressLog');
        const progressSpinner = document.getElementById('progressSpinner');
        const progressTitle = document.getElementById('progressTitle');
        const colorPalette = document.getElementById('colorPalette');
        const addColorBtn = document.getElementById('addColorBtn');
        const colorPicker = document.getElementById('colorPicker');
        const suggestedInfo = document.getElementById('suggestedInfo');
        
        // Preview elements
        const originalPreview = document.getElementById('originalPreview');
        const svgPreview = document.getElementById('svgPreview');
        
        // Controls
        const colorsSlider = document.getElementById('colors');
        const colorsValue = document.getElementById('colorsValue');
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('thresholdValue');
        const rasterDpiSlider = document.getElementById('rasterDpi');
        const rasterDpiValue = document.getElementById('rasterDpiValue');
        
        // Update range values
        colorsSlider.addEventListener('input', () => {
            colorsValue.textContent = colorsSlider.value;
        });
        
        thresholdSlider.addEventListener('input', () => {
            thresholdValue.textContent = thresholdSlider.value;
        });
        
        rasterDpiSlider.addEventListener('input', () => {
            rasterDpiValue.textContent = rasterDpiSlider.value;
        });
        
        // Show/hide rasterize options based on gradient mode
        document.getElementById('gradientMode').addEventListener('change', (e) => {
            const rasterizeOptions = document.getElementById('rasterizeOptions');
            if (e.target.value === 'rasterize') {
                rasterizeOptions.style.display = 'block';
            } else {
                rasterizeOptions.style.display = 'none';
            }
        });
        
        // Color palette management
        function updateColorPalette() {
            // Clear existing color chips except the add button
            const existingChips = colorPalette.querySelectorAll('.color-chip:not(.add-color)');
            existingChips.forEach(chip => chip.remove());
            
            // Add color chips
            suggestedColors.forEach((color, index) => {
                const chip = document.createElement('div');
                chip.className = 'color-chip selected';
                chip.style.backgroundColor = color;
                chip.dataset.color = color;
                chip.dataset.index = index;
                
                chip.addEventListener('click', () => {
                    // Remove color on click
                    suggestedColors.splice(index, 1);
                    updateColorPalette();
                });
                
                colorPalette.insertBefore(chip, addColorBtn);
            });
            
            // Update info text
            if (suggestedColors.length > 0) {
                suggestedInfo.textContent = `${suggestedColors.length} color${suggestedColors.length > 1 ? 's' : ''} selected. Click a color to remove it.`;
            } else {
                suggestedInfo.textContent = 'Click + to add colors you want in the palette';
            }
        }
        
        // Add color button
        addColorBtn.addEventListener('click', () => {
            colorPicker.click();
        });
        
        colorPicker.addEventListener('change', (e) => {
            const color = e.target.value;
            if (!suggestedColors.includes(color)) {
                suggestedColors.push(color);
                updateColorPalette();
            }
        });
        
        // Sample from image on click (when original is shown)
        originalPreview.addEventListener('click', (e) => {
            if (currentTab !== 'original' || !currentFile) return;
            
            // Create a canvas to sample the color
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = originalPreview;
            
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            
            // Calculate click position
            const rect = img.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / rect.width * canvas.width);
            const y = Math.floor((e.clientY - rect.top) / rect.height * canvas.height);
            
            // Get pixel color
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const r = pixel[0].toString(16).padStart(2, '0');
            const g = pixel[1].toString(16).padStart(2, '0');
            const b = pixel[2].toString(16).padStart(2, '0');
            const hexColor = `#${r}${g}${b}`;
            
            if (!suggestedColors.includes(hexColor)) {
                suggestedColors.push(hexColor);
                updateColorPalette();
            }
        });
        
        // Add cursor style for color picking
        originalPreview.style.cursor = 'crosshair';
        
        // File upload - only trigger if not clicking the clear button
        uploadArea.addEventListener('click', (e) => {
            if (!e.target.classList.contains('clear-file-btn')) {
                if (!currentFile) {
                    fileInput.click();
                }
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                showTab(btn.dataset.tab);
            });
        });
        
        function updateUploadArea(file) {
            if (file) {
                // Show compact file info
                const uploadContent = document.getElementById('uploadContent');
                uploadArea.classList.add('has-file');
                
                // Get file icon based on type
                let fileIcon = '📄';
                const ext = file.name.toLowerCase().split('.').pop();
                if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'].includes(ext)) {
                    fileIcon = '🖼️';
                } else if (ext === 'svg') {
                    fileIcon = '🎨';
                }
                
                uploadContent.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <span class="file-name" title="${file.name}">${file.name}</span>
                    </div>
                    <button class="clear-file-btn" onclick="clearFile()">Clear</button>
                `;
            } else {
                // Reset to original state
                uploadArea.classList.remove('has-file');
                const uploadContent = document.getElementById('uploadContent');
                uploadContent.innerHTML = `
                    <div class="upload-icon">📁</div>
                    <p>Click to upload or drag & drop</p>
                    <p style="font-size: 12px; color: #a0aec0; margin-top: 10px;">
                        PNG, JPG, GIF, BMP, or SVG
                    </p>
                `;
            }
        }
        
        function clearFile() {
            currentFile = null;
            currentSVG = null;
            fileInput.value = '';
            convertBtn.disabled = true;
            downloadBtn.disabled = true;
            
            // Reset upload area
            updateUploadArea(null);
            
            // Clear previews
            originalPreview.src = '';
            placeholder.style.display = 'flex';
            resultContainer.innerHTML = '';
            progressContainer.style.display = 'none';
            
            // Hide SVG options
            document.getElementById('svgOptions').style.display = 'none';
            
            // Reset to original tab
            showTab('original');
        }
        
        // Make clearFile globally accessible
        window.clearFile = clearFile;
        
        function handleFile(file) {
            if (!file) return;
            
            currentFile = file;
            convertBtn.disabled = false;
            downloadBtn.disabled = true;
            currentSVG = null;
            
            // Update upload area to show file info
            updateUploadArea(file);
            
            // Show/hide SVG options based on file type
            const svgOptions = document.getElementById('svgOptions');
            if (file.name.toLowerCase().endsWith('.svg')) {
                svgOptions.style.display = 'block';
            } else {
                svgOptions.style.display = 'none';
            }
            
            // Show original preview
            const reader = new FileReader();
            reader.onload = (e) => {
                originalPreview.src = e.target.result;
                placeholder.style.display = 'none';
                previewTabs.style.display = 'flex';
                showTab('original');
            };
            reader.readAsDataURL(file);
        }
        
        function showTab(tab) {
            currentTab = tab;
            originalPreview.style.display = 'none';
            svgPreview.style.display = 'none';
            
            switch(tab) {
                case 'original':
                    originalPreview.style.display = 'block';
                    break;
                case 'svg':
                    if (currentSVG) {
                        svgPreview.style.display = 'block';
                    }
                    break;
            }
        }
        
        function addLogEntry(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            // Add timestamp
            const now = new Date();
            const timestamp = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            entry.textContent = `[${timestamp}] ${message}`;
            progressLog.appendChild(entry);
            
            // Auto-scroll to bottom to show latest entry
            setTimeout(() => {
                progressLog.scrollTop = progressLog.scrollHeight;
            }, 10);
        }
        
        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;
            
            // Clear previous logs and show spinner
            progressLog.innerHTML = '';
            progressSpinner.classList.add('active');
            progressTitle.textContent = 'Converting...';
            convertBtn.disabled = true;
            downloadBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('colors', colorsSlider.value);
            formData.append('method', document.getElementById('method').value);
            formData.append('threshold', thresholdSlider.value);
            formData.append('simplify', document.getElementById('simplify').checked);
            formData.append('includeBackground', document.getElementById('includeBackground').checked);
            
            // Add gradient mode if it's an SVG file
            if (currentFile.name.toLowerCase().endsWith('.svg')) {
                const gradientMode = document.getElementById('gradientMode').value;
                formData.append('gradientMode', gradientMode);
                
                // Add DPI if rasterizing
                if (gradientMode === 'rasterize') {
                    formData.append('rasterDpi', rasterDpiSlider.value);
                }
            }
            
            // Add suggested colors as JSON
            const colorsHex = suggestedColors.map(c => c.replace('#', ''));
            formData.append('suggestedColors', JSON.stringify(colorsHex));
            
            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            switch(data.type) {
                                case 'status':
                                    addLogEntry('status', data.message);
                                    break;
                                
                                case 'log':
                                    addLogEntry('log', data.message);
                                    break;
                                
                                case 'error':
                                    addLogEntry('error', 'Error: ' + data.message);
                                    alert('Error: ' + data.message);
                                    convertBtn.disabled = false;
                                    progressSpinner.classList.remove('active');
                                    progressTitle.textContent = 'Conversion Failed';
                                    return;
                                
                                case 'complete':
                                    addLogEntry('status', 'Conversion complete!');
                                    
                                    currentSVG = data.svg;
                                    
                                    // Show SVG preview
                                    const parser = new DOMParser();
                                    const svgDoc = parser.parseFromString(data.svg, 'image/svg+xml');
                                    const svgElement = svgDoc.querySelector('svg');
                                    
                                    if (svgElement) {
                                        if (!svgElement.getAttribute('viewBox')) {
                                            const width = svgElement.getAttribute('width') || '100';
                                            const height = svgElement.getAttribute('height') || '100';
                                            svgElement.setAttribute('viewBox', `0 0 ${width} ${height}`);
                                        }
                                        svgElement.removeAttribute('width');
                                        svgElement.removeAttribute('height');
                                        svgElement.style.width = '100%';
                                        svgElement.style.height = '100%';
                                        svgElement.style.objectFit = 'contain';
                                    }
                                    
                                    svgPreview.innerHTML = '';
                                    svgPreview.appendChild(svgElement);
                                    svgPreview.style.display = 'none';
                                    
                                    // Enable download and update status
                                    downloadBtn.disabled = false;
                                    convertBtn.disabled = false;
                                    progressSpinner.classList.remove('active');
                                    progressTitle.textContent = 'Conversion Complete';
                                    
                                    // Switch to SVG tab
                                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                                    document.querySelector('[data-tab="svg"]').classList.add('active');
                                    showTab('svg');
                                    break;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                addLogEntry('error', 'Connection error: ' + error.message);
                convertBtn.disabled = false;
                progressSpinner.classList.remove('active');
                progressTitle.textContent = 'Connection Error';
            }
        });
        
        downloadBtn.addEventListener('click', async () => {
            if (!currentSVG) return;
            
            try {
                const response = await fetch('/download-svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        svg: currentSVG,
                        colors: colorsSlider.value,
                        filename: currentFile ? currentFile.name : 'converted'
                    })
                });
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Generate filename with color count
                let baseFilename = currentFile ? currentFile.name : 'converted';
                if (baseFilename.includes('.')) {
                    baseFilename = baseFilename.substring(0, baseFilename.lastIndexOf('.'));
                }
                a.download = `${baseFilename}_${colorsSlider.value}colors.svg`;
                
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error downloading: ' + error.message);
            }
        });
    </script>
</body>
</html>